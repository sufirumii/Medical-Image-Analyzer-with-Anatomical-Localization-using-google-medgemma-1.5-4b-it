# MEDICAL IMAGE ANALYZER WITH FORCED BOUNDING BOXES
# Run this entire cell in Jupyter Notebook

from transformers import AutoProcessor, AutoModelForImageTextToText
import torch
from PIL import Image, ImageDraw, ImageFont
import requests
from IPython.display import display, Markdown, HTML
import os
import warnings
from datetime import datetime
import base64
from io import BytesIO
import re
warnings.filterwarnings('ignore')

# ============= MODEL LOADING =============
print("üöÄ Loading Medical Report Translator powered by MedGemma...")

model_id = "google/medgemma-1.5-4b-it"

model = AutoModelForImageTextToText.from_pretrained(
    model_id,
    torch_dtype=torch.bfloat16,
    device_map="auto",
    low_cpu_mem_usage=True
)

processor = AutoProcessor.from_pretrained(
    model_id,
    use_fast=True
)

print("‚úÖ Model loaded successfully!")

# ============= BOUNDING BOX PARSING =============
def parse_bounding_boxes(text):
    """Parse bounding box coordinates from model output."""
    boxes = []
    labels = []
    
    # Look for patterns like: [x1,y1,x2,y2] or (x1,y1,x2,y2)
    pattern = r'[\(\[]\s*(\d+)[,\s]+(\d+)[,\s]+(\d+)[,\s]+(\d+)\s*[\)\]]'
    matches = re.finditer(pattern, text)
    
    for match in matches:
        coords = [int(match.group(1)), int(match.group(2)), int(match.group(3)), int(match.group(4))]
        
        # Try to find a label near the coordinates
        context = text[max(0, match.start()-50):min(len(text), match.end()+50)]
        label_match = re.search(r'(\w+(?:\s+\w+)*)\s*[:\-]?\s*' + re.escape(match.group(0)), context)
        
        if label_match:
            label = label_match.group(1)
        else:
            label = f"region_{len(boxes)+1}"
        
        if all(0 <= c <= 1000 for c in coords):
            boxes.append(coords)
            labels.append(label)
    
    return boxes, labels

# ============= DRAW BOUNDING BOXES =============
def draw_boxes_on_image(image, boxes, labels):
    """Draw bounding boxes on the image."""
    img_with_boxes = image.copy()
    draw = ImageDraw.Draw(img_with_boxes)
    width, height = image.size
    
    colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEEAD', '#D4A5A5', '#9B59B6', '#3498DB', '#E67E22', '#2ECC71']
    
    try:
        font = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf", 16)
    except:
        font = ImageFont.load_default()
    
    for i, (box, label) in enumerate(zip(boxes, labels)):
        color = colors[i % len(colors)]
        
        x1 = int(box[0] * width / 1000)
        y1 = int(box[1] * height / 1000)
        x2 = int(box[2] * width / 1000)
        y2 = int(box[3] * height / 1000)
        
        # Draw rectangle
        draw.rectangle([x1, y1, x2, y2], outline=color, width=3)
        
        # Draw label with background
        label_text = f"{label}"
        text_bbox = draw.textbbox((x1, y1-25), label_text, font=font)
        draw.rectangle(text_bbox, fill=color)
        draw.text((x1, y1-25), label_text, fill='white', font=font)
    
    return img_with_boxes

# ============= ANALYSIS WITH FORCED BOUNDING BOXES =============
def analyze_with_bbox(image_path=None, image_url=None, image_pil=None):
    """
    Analyze medical image with explicit bounding box output.
    """
    
    # Load image
    if image_pil is not None:
        image = image_pil
        source = "PIL Image"
    elif image_path is not None:
        image = Image.open(image_path)
        source = image_path
    elif image_url is not None:
        image = Image.open(requests.get(image_url, stream=True).raw)
        source = image_url
    else:
        print("‚ùå Please provide an image")
        return
    
    from IPython.display import clear_output
    clear_output(wait=True)
    
    # EXTREMELY SPECIFIC PROMPT - Force bounding boxes
    prompt = """You are a medical imaging AI. Your task is to analyze this image and provide bounding box coordinates for ALL anatomical structures and abnormalities.

YOU MUST OUTPUT BOUNDING BOXES IN THIS EXACT FORMAT FOR EACH ITEM:

<bbox>[x1,y1,x2,y2] label: structure_name</bbox>

Where coordinates are between 0-1000. For example:
<bbox>[320,180,680,420] label: Heart</bbox>
<bbox>[180,120,480,580] label: Right Lung</bbox>
<bbox>[520,120,820,580] label: Left Lung</bbox>
<bbox>[450,100,550,700] label: Spine</bbox>
<bbox>[470,40,530,100] label: Trachea</bbox>
<bbox>[250,550,450,650] label: Right Diaphragm</bbox>
<bbox>[550,550,750,650] label: Left Diaphragm</bbox>

If you see any abnormalities or masses, also output them with bounding boxes:
<bbox>[x1,y1,x2,y2] label: Mass/Tumor/Lesion</bbox>

Now, analyze this image and output ALL visible structures with bounding boxes.

SEVERITY: [URGENT/CONCERNING/NORMAL]

ANATOMICAL STRUCTURES (with bboxes):
[Output all structures you can identify using the <bbox> format]

ABNORMALITIES/FINDINGS (with bboxes if any):
[Output any abnormalities using the <bbox> format]

SIMPLE EXPLANATION:
[Explain in plain English]

KEY POINTS:
‚Ä¢ 
‚Ä¢ 
‚Ä¢ 

QUESTIONS FOR DOCTOR:
‚Ä¢ 
‚Ä¢ 
‚Ä¢ 

NEXT STEPS:
‚Ä¢ 
‚Ä¢ 
‚Ä¢ 

REMEMBER: You MUST include bounding boxes using the <bbox> format for ALL structures you identify!"""
    
    messages = [
        {
            "role": "user",
            "content": [
                {"type": "image", "image": image},
                {"type": "text", "text": prompt}
            ]
        }
    ]
    
    inputs = processor.apply_chat_template(
        messages,
        add_generation_prompt=True,
        tokenize=True,
        return_dict=True,
        return_tensors="pt"
    ).to(model.device)
    
    input_len = inputs["input_ids"].shape[-1]
    
    print("üî¨ Analyzing image with MedGemma (forcing bounding boxes)... Please wait")
    
    with torch.inference_mode():
        generation = model.generate(
            **inputs, 
            max_new_tokens=2500,
            do_sample=False,
            temperature=0.1
        )
        generation = generation[0][input_len:]
    
    result = processor.decode(generation, skip_special_tokens=True)
    result = result.replace("<start_of_turn>", "").replace("<end_of_turn>", "").strip()
    
    # Parse boxes using our improved parser
    boxes, labels = parse_bounding_boxes(result)
    
    # Also try to parse the specific <bbox> format
    bbox_pattern = r'<bbox>\s*[\(\[]\s*(\d+)[,\s]+(\d+)[,\s]+(\d+)[,\s]+(\d+)\s*[\)\]]\s*label:\s*([^<]+)</bbox>'
    bbox_matches = re.finditer(bbox_pattern, result, re.IGNORECASE)
    
    for match in bbox_matches:
        coords = [int(match.group(1)), int(match.group(2)), int(match.group(3)), int(match.group(4))]
        label = match.group(5).strip()
        if all(0 <= c <= 1000 for c in coords):
            # Avoid duplicates
            if coords not in boxes:
                boxes.append(coords)
                labels.append(label)
    
    clear_output(wait=True)
    
    # Convert images
    buffered_original = BytesIO()
    image.save(buffered_original, format="JPEG")
    img_original_str = base64.b64encode(buffered_original.getvalue()).decode()
    
    # Draw boxes if any found
    if boxes:
        img_with_boxes = draw_boxes_on_image(image, boxes, labels)
        buffered_boxes = BytesIO()
        img_with_boxes.save(buffered_boxes, format="JPEG")
        img_boxes_str = base64.b64encode(buffered_boxes.getvalue()).decode()
        box_count = len(boxes)
    else:
        img_boxes_str = img_original_str
        box_count = 0
    
    # Severity
    if "URGENT" in result.upper():
        severity_color = "#dc3545"
        severity_bg = "#f8d7da"
        severity_icon = "üî¥"
        severity_text = "URGENT - Immediate Attention Required"
    elif "CONCERNING" in result.upper():
        severity_color = "#fd7e14"
        severity_bg = "#fff3cd"
        severity_icon = "üü°"
        severity_text = "CONCERNING - Follow Up Within 1-2 Weeks"
    else:
        severity_color = "#28a745"
        severity_bg = "#d4edda"
        severity_icon = "üü¢"
        severity_text = "NORMAL - Routine Finding"
    
    # HTML Output
    html_output = f"""
    <div style="font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
        
        <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #2c3e50; font-size: 2.5em; margin-bottom: 5px;">üè• Medical Image Analysis Report</h1>
            <p style="color: #7f8c8d; font-size: 1.1em;">Powered by Google MedGemma 1.5 ‚Ä¢ Bounding Box Detection</p>
        </div>
        
        <div style="background: {severity_bg}; border-left: 8px solid {severity_color}; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <span style="font-size: 3em;">{severity_icon}</span>
                <div>
                    <h2 style="color: {severity_color}; margin: 0; font-size: 1.8em;">{severity_text}</h2>
                </div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                <h3 style="color: #2c3e50; margin-top: 0; text-align: center;">üì∏ Original Image</h3>
                <img src="data:image/jpeg;base64,{img_original_str}" style="width: 100%; border-radius: 8px;">
                <p style="color: #6c757d; text-align: center; margin-top: 10px;">{os.path.basename(source)} ‚Ä¢ {image.size[0]} x {image.size[1]}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                <h3 style="color: #2c3e50; margin-top: 0; text-align: center;">üîç With Bounding Boxes</h3>
                <img src="data:image/jpeg;base64,{img_boxes_str}" style="width: 100%; border-radius: 8px;">
                <p style="color: #6c757d; text-align: center; margin-top: 10px;"><strong>{box_count}</strong> structure(s) identified with bounding boxes</p>
            </div>
        </div>
        
        {f'''
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
            <h3 style="color: #2c3e50; margin-top: 0;">üìã Detected Structures & Coordinates</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px;">
                {''.join([f'<div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #FF6B6B; box-shadow: 0 2px 5px rgba(0,0,0,0.05);"><strong>{label}</strong><br><span style="color: #666; font-size: 0.9em;">({box[0]}, {box[1]}) ‚Üí ({box[2]}, {box[3]})</span></div>' for box, label in zip(boxes, labels)])}
            </div>
        </div>
        ''' if boxes else '''
        <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
            <p style="color: #856404; margin: 0;"><strong>‚ö†Ô∏è Note:</strong> No bounding boxes were detected in the model output. The model provided text analysis but didn't output coordinates in the expected format.</p>
        </div>
        '''}
        
        <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 30px;">
            <h3 style="color: #2c3e50; margin-top: 0; border-bottom: 2px solid #dee2e6; padding-bottom: 10px;">üìã FULL ANALYSIS</h3>
            <div style="font-family: 'Courier New', monospace; white-space: pre-wrap; line-height: 1.6; background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                {result.replace(chr(10), '<br>')}
            </div>
        </div>
        
        <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <p style="color: #721c24; margin: 0; font-size: 0.95em;">
                <strong>‚ö†Ô∏è IMPORTANT DISCLAIMER:</strong> This analysis is generated by an AI system and is for informational purposes only. 
                Always consult with a qualified healthcare provider for medical advice.
            </p>
        </div>
        
        <div style="text-align: center; color: #6c757d; font-size: 0.9em; border-top: 1px solid #dee2e6; padding-top: 20px;">
            <p>Analysis generated: {datetime.now().strftime('%B %d, %Y at %I:%M %p')}</p>
        </div>
    </div>
    """
    
    display(HTML(html_output))
    
    if boxes:
        print(f"\n‚úÖ Successfully detected {len(boxes)} structures with bounding boxes!")
        for box, label in zip(boxes, labels):
            print(f"   ‚Ä¢ {label}: [{box[0]}, {box[1]}, {box[2]}, {box[3]}]")
    else:
        print("\n‚ö†Ô∏è The model provided analysis but didn't output bounding boxes.")
        print("   This could be because:")
        print("   ‚Ä¢ The image type may not be ideal for bounding box detection")
        print("   ‚Ä¢ The model needs more specific training for this task")
        print("   ‚Ä¢ Try a different image (chest X-ray works best for anatomical localization)")
    
    return result, boxes, labels

# ============= ANALYZE YOUR IMAGE =============
print("\n" + "="*70)
print("üîç READY TO ANALYZE YOUR MEDICAL IMAGE WITH BOUNDING BOXES")
print("="*70)

image_file = "41598_2023_41576_Fig1_HTML.jpg"

if os.path.exists(image_file):
    print(f"\n‚úÖ Found image: {image_file}")
    print(f"üìè File size: {os.path.getsize(image_file)} bytes")
    
    print("\n" + "="*70)
    input("üîÑ Press Enter to analyze this image with forced bounding boxes...")
    
    result, boxes, labels = analyze_with_bbox(image_path=image_file)
    
else:
    print(f"\n‚ùå ERROR: Could not find file '{image_file}'")
